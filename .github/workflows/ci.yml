name: Cloud Sim Banking CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  monitoring:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Verify Prometheus config exists
      - name: Verify Prometheus config exists
        run: |
          if [ ! -f ./Monitoring/prometheus.yml ]; then
            echo "Error: prometheus.yml not found in ./monitoring"
            exit 1
          fi
          ls -l ./Monitoring/prometheus.yml

      # 3️⃣ Verify ports are free (optional but recommended)
      - name: Check ports
        run: |
          for port in 8000 8001 9090; do
            if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null ; then
              echo "Port $port is in use. Killing process..."
              sudo kill -9 $(lsof -t -i:$port)
            fi
          done

      # 4️⃣ Start Kong container
      - name: Start Kong container
        run: |
          docker run -d \
            --name kong \
            -p 8000:8000 \   # proxy
            -p 8443:8443 \   # proxy HTTPS
            -p 8001:8001 \   # admin API
            -p 8444:8444 \   # admin HTTPS
            kong:latest

      # 5️⃣ Start Prometheus container
      - name: Start Prometheus container
        run: |
          docker run -d \
            --name prometheus \
            -v ${{ github.workspace }}/Monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            -p 9090:9090 \
            prom/prometheus:latest

      # 6️⃣ Verify containers are running
      - name: List running containers
        run: docker ps
